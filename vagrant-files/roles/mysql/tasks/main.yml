---
- name: Install packages
  apk:
    name:
      - mysql
      - mysql-client
      - py3-mysqlclient
  become: true
- name: Check if mysql is installed
  stat:
    path: ~/mysql_install.lock
  register: install_lock
- name: Prepare mysql
  shell: mysql_install_db --user=mysql --datadir=/var/lib/mysql && /etc/init.d/mariadb setup
  become: true
  when: install_lock.stat.exists == false
- name: Touch installed file
  file:
    state: touch
    path: ~/mysql_install.lock
- name: Start mysql
  service:
    name: mariadb
    state: started
  become: true
  when: install_lock.stat.exists == false
- name: Set root password
  shell: mysqladmin -u {{mysql_root_user}} password {{mysql_root_password}}
  become: true
  when: install_lock.stat.exists == false
- name: Copy config
  copy:
    dest: /etc/my.cnf.d/mariadb-server.cnf
    src: /vagrant/vagrant-files/roles/mysql/files/maria-server-jinya.cnf
  become: true
  when: install_lock.stat.exists == false
- name: Create database jinya-gallery-cms
  mysql_db:
    name: jinya-gallery-cms
    state: present
    login_user: "{{mysql_root_user}}"
    login_password: "{{mysql_root_password}}"
  when: install_lock.stat.exists == false
- name:
  mysql_user:
    name: "{{mysql_jinya_user}}"
    password: "{{mysql_jinya_password}}"
    priv: '*.*:ALL,GRANT'
    state: present
    login_user: "{{mysql_root_user}}"
    login_password: "{{mysql_root_password}}"
  become: true
  when: install_lock.stat.exists == false
- name: Import database jinya-gallery-cms
  mysql_db:
    name: jinya-gallery-cms
    state: import
    login_user: "{{mysql_root_user}}"
    login_password: "{{mysql_root_password}}"
    target: /vagrant/vagrant-files/jinya-gallery-cms.sql
  when: install_lock.stat.exists == false
- name: Restart mysql
  service:
    name: mariadb
    state: restarted
  become: true
  when: install_lock.stat.exists == false